<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/wrappers/BlocklyWrapper.js | &#x422;&#x430;&#x43F;&#x430;&#x43D;&#x434;&#x430;: &#x41C;&#x430;&#x43A;&#x435;&#x442;&#x43D;&#x430;&#x44F; &#x43F;&#x43B;&#x430;&#x442;&#x430;</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="&#x41F;&#x430;&#x43A;&#x435;&#x442; frontend-&#x440;&#x435;&#x448;&#x435;&#x43D;&#x438;&#x439; &#x434;&#x43B;&#x44F; &#x43F;&#x440;&#x43E;&#x435;&#x43A;&#x442;&#x430; &#x427;&#x430;&#x441; &#x43A;&#x43E;&#x434;&#x430;"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="&#x422;&#x430;&#x43F;&#x430;&#x43D;&#x434;&#x430;: &#x41C;&#x430;&#x43A;&#x435;&#x442;&#x43D;&#x430;&#x44F; &#x43F;&#x43B;&#x430;&#x442;&#x430;"><meta property="twitter:description" content="&#x41F;&#x430;&#x43A;&#x435;&#x442; frontend-&#x440;&#x435;&#x448;&#x435;&#x43D;&#x438;&#x439; &#x434;&#x43B;&#x44F; &#x43F;&#x440;&#x43E;&#x435;&#x43A;&#x442;&#x430; &#x427;&#x430;&#x441; &#x43A;&#x43E;&#x434;&#x430;"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a href="https://bitbucket.org/makeitlab/codehour-breadboard-web">Repository</a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/admin_blockly.js~AdminBlocklyApplication.html">AdminBlocklyApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/admin_board.js~AdminBoardApplication.html">AdminBoardApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/index.js~Application.html">Application</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/core/Dispatcher.js~Dispatcher.html">Dispatcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/core/Loggable.js~Loggable.html">Loggable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/core/Module.js~Module.html">Module</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/core/Wrapper.js~Wrapper.html">Wrapper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules">modules</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/BreadboardModule.js~BreadboardModule.html">BreadboardModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/GUIModule.js~GUIModule.html">GUIModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/GlobalServiceModule.js~GlobalServiceModule.html">GlobalServiceModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/InstructorModule.js~InstructorModule.html">InstructorModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/LayoutModule.js~LayoutModule.html">LayoutModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/LocalServiceModule.js~LocalServiceModule.html">LocalServiceModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/LogModule.js~LogModule.html">LogModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/TracingModule.js~TracingModule.html">TracingModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/modules/WorkspaceModule.js~WorkspaceModule.html">WorkspaceModule</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#wrappers">wrappers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/AlertifierWrapper.js~AlertifierWrapper.html">AlertifierWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/BlocklyWrapper.js~BlocklyWrapper.html">BlocklyWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/BreadboardWrapper.js~BreadboardWrapper.html">BreadboardWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/ElectronIPCWrapper.js~ElectronIPCWrapper.html">ElectronIPCWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/FileWrapper.js~FileWrapper.html">FileWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/IdentifierWrapper.js~IdentifierWrapper.html">IdentifierWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/KbdPaneWrapper.js~KbdPaneWrapper.html">KbdPaneWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/LaunchBtnWrapper.js~LaunchBtnWrapper.html">LaunchBtnWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/LessonPaneWrapper.js~LessonPaneWrapper.html">LessonPaneWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/SocketWrapper.js~SocketWrapper.html">SocketWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/SpinnerWrapper.js~SpinnerWrapper.html">SpinnerWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/TextPaneWrapper.js~TextPaneWrapper.html">TextPaneWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/wrappers/TourWrapper.js~TourWrapper.html">TourWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://developers.google.com/blockly/reference/js/Blockly.BlockSvg">Blockly.BlockSvg</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/wrappers/BlocklyWrapper.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @external {Blockly.BlockSvg} https://developers.google.com/blockly/reference/js/Blockly.BlockSvg
 */

import Wrapper from &apos;../core/Wrapper&apos;

import Blockly  from &apos;node-blockly/browser&apos;
import Ru       from &apos;node-blockly/lib/i18n/ru&apos;;

import thm      from &apos;../../css/blockly-dimmer.css&apos;;

Blockly.setLocale(Ru);

const ERROR_COLOUR = &quot;#920000&quot;;

const DIV_IDS = {
    BLOCKLY: &quot;blockly-div&quot;,
    TOOLBOX: &quot;blockly-toolbox&quot;,
    DIMMER: &quot;blockly-dimmer&quot;
};

const DIV_CLASSES = {
    DIMMER_HIDDEN: &quot;blockly-dimmer-hidden&quot;,
};

const FIELD_TYPES = {
    NUMBER: &quot;number&quot;,
    STRING: &quot;string&quot;,
    COLOUR: &quot;colour&quot;
};

/** &#x413;&#x43B;&#x43E;&#x431;&#x430;&#x43B;&#x44C;&#x43D;&#x430;&#x44F; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x430;&#x44F;, &#x43E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x44E;&#x449;&#x430;&#x44F;, &#x437;&#x430;&#x433;&#x440;&#x443;&#x436;&#x435;&#x43D;&#x44B; &#x43B;&#x438; &#x443;&#x436;&#x435; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432; &#x432; Blockly
 *  &#x412;&#x438;&#x434;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x44C; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; &#x43D;&#x435;&#x43E;&#x431;&#x445;&#x43E;&#x434;&#x438;&#x43C;&#x430; &#x432; &#x43E;&#x431;&#x43B;&#x430;&#x441;&#x442;&#x438; &apos;window&apos;,
 *  &#x442;.&#x43A;. &#x432;&#x441;&#x435; &#x44D;&#x43A;&#x437;&#x435;&#x43C;&#x43F;&#x43B;&#x44F;&#x440;&#x44B; Blockly &#x442;&#x430;&#x436;&#x435; &#x438;&#x43C;&#x435;&#x44E;&#x442; &#x43A; &#x43D;&#x435;&#x439; &#x434;&#x43E;&#x441;&#x442;&#x443;&#x43F;
 */
window.BLOCKLY_BTS_REG = false;

/**
 * &#x41E;&#x431;&#x451;&#x440;&#x442;&#x43A;&#x430; &#x431;&#x438;&#x431;&#x43B;&#x438;&#x43E;&#x442;&#x435;&#x43A;&#x438; Blockly &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x441;&#x440;&#x435;&#x434;&#x44B; &#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x44F;
 */
export default class BlocklyWrapper extends Wrapper {
    static get BLOCKLY_BLOCK_TYPES_REGISTERED() {return BLOCKLY_BTS_REG}

    constructor() {
        super();

        this.area               = undefined;     // &#x443;&#x437;&#x435;&#x43B; &#x432;&#x441;&#x442;&#x430;&#x432;&#x43A;&#x438; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x430;
        this.container          = undefined;     // &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440; Blockly
        this.toolbox            = undefined;     // &#x443;&#x437;&#x435;&#x43B; &#x441; &#x43E;&#x43F;&#x438;&#x441;&#x430;&#x43D;&#x438;&#x435;&#x43C; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
        this.dimmer            = undefined;     // &#x441;&#x43B;&#x43E;&#x439; &#x437;&#x430;&#x442;&#x435;&#x43C;&#x43D;&#x435;&#x43D;&#x438;&#x44F;
        this.workspace          = undefined;     // SVG-&#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440; &#x441; &#x433;&#x440;&#x430;&#x444;&#x438;&#x43A;&#x43E;&#x439; Blockly

        // &#x411;&#x43B;&#x43E;&#x43A;&#x438;
        this._block_types       = undefined;     // JSON-&#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
        this._generators        = undefined;     // JS-&#x433;&#x435;&#x43D;&#x435;&#x440;&#x430;&#x442;&#x43E;&#x440; &#x43A;&#x43E;&#x434;&#x430;
        this._audibles          = undefined;     // &#x41F;&#x440;&#x43E;&#x441;&#x43B;&#x443;&#x448;&#x438;&#x432;&#x430;&#x435;&#x43C;&#x44B;&#x435; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;

        // &#x424;&#x43B;&#x430;&#x433;&#x438;
        this.silent             = false;          // &quot;&#x442;&#x438;&#x445;&#x438;&#x439;&quot; &#x440;&#x435;&#x436;&#x438;&#x43C;, &#x43D;&#x435; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x442;&#x44C; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x44F;
        this.extra_fields       = false;          // &#x440;&#x435;&#x436;&#x438;&#x43C; &#x434;&#x43E;&#x43F;. &#x43F;&#x43E;&#x43B;&#x435;&#x439;, &#x434;&#x43B;&#x44F; &#x430;&#x434;&#x43C;&#x438;&#x43D;&#x43A;&#x438;

        // &#x41F;&#x440;&#x43E;&#x447;&#x435;&#x435;
        this._error_blocks      = {};             // &#x431;&#x43B;&#x43E;&#x43A;&#x438;, &#x43F;&#x43E;&#x43C;&#x435;&#x447;&#x435;&#x43D;&#x43D;&#x44B;&#x435; &#x43A;&#x430;&#x43A; &#x43E;&#x448;&#x438;&#x431;&#x43E;&#x447;&#x43D;&#x44B;&#x435;
        this._variable_blocks   = [];             // &#x431;&#x43B;&#x43E;&#x43A;&#x438;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x44B;&#x435;

        this._state = {
            lastCodeMain: undefined,            // &#x43F;&#x43E;&#x441;&#x43B;&#x435;&#x434;&#x43D;&#x435;&#x435; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x435; &#x433;&#x43B;&#x430;&#x432;&#x43D;&#x43E;&#x433;&#x43E; &#x43A;&#x43E;&#x434;&#x430;
            changeListenerRegistered: false,    // &#x437;&#x430;&#x440;&#x435;&#x433;&#x438;&#x441;&#x442;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D; &#x43B;&#x438; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x439; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F;
            code_buffer: undefined              // &#x431;&#x443;&#x444;&#x435;&#x440; &#x43A;&#x43E;&#x434;&#x430;, &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x443;&#x435;&#x442;&#x441;&#x44F; &#x43F;&#x440;&#x438; &#x432;&#x441;&#x442;&#x440;&#x430;&#x438;&#x432;&#x430;&#x43D;&#x438;&#x438;-&#x443;&#x434;&#x430;&#x43B;&#x435;&#x43D;&#x438;&#x438;
        };

        this._callbacks = {
            onChange: (statement) =&gt; {
                this._debug.warn(&quot;onChangeMain default callback was called&quot;, statement)
            },
            onChangeAudible: (block_code, statement) =&gt; {
                this._debug.warn(&quot;onChangeAudible default callback was called&quot;, block_code, statement)
            }
        };

        // &#x41A;&#x43E;&#x43D;&#x444;&#x438;&#x433;&#x443;&#x440;&#x430;&#x446;&#x438;&#x44F; Blockly
        Blockly.HSV_SATURATION = 1;
        Blockly.HSV_HUE = 1;
    }

    /**
     * &#x417;&#x430;&#x440;&#x435;&#x433;&#x438;&#x441;&#x442;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432; &#x432; Blockly
     *
     * &#x424;&#x43E;&#x440;&#x43C;&#x430;&#x442; &#x432;&#x445;&#x43E;&#x434;&#x43D;&#x44B;&#x445; &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445; &#x441;&#x43C;. &#x432; &#x440;&#x430;&#x437;&#x434;&#x435;&#x43B;&#x430;&#x445; Block Definition &#x438; Define Blocks
     * (&#x432;&#x43E; &#x432;&#x43A;&#x43B;&#x430;&#x434;&#x43A;&#x430;&#x445; JavaScript)
     *
     * @see https://developers.google.com/blockly/guides/configure/web/custom-blocks
     * @see https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks
     *
     * @param {Object} blocksJSON &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x444;&#x43E;&#x440;&#x43C;&#x430;&#x442;&#x430; Blockly (JavaScript), &#x437;&#x430;&#x434;&#x430;&#x44E;&#x449;&#x438;&#x439; &#x43E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x435;&#x43D;&#x438;&#x44F; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     */
    registerBlockTypes(blocksJSON) {
        this._block_types = blocksJSON;

        this._loadBlocksJSON();

        BLOCKLY_BTS_REG = true;
    }

    /**
     * &#x417;&#x430;&#x440;&#x435;&#x433;&#x438;&#x441;&#x442;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x433;&#x435;&#x43D;&#x435;&#x440;&#x430;&#x442;&#x43E;&#x440;&#x44B; &#x43A;&#x43E;&#x434;&#x430; &#x432; Blockly
     *
     * &#x424;&#x43E;&#x440;&#x43C;&#x430;&#x442; &#x432;&#x445;&#x43E;&#x434;&#x43D;&#x44B;&#x445; &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445; &#x441;&#x43C;. &#x432; &#x440;&#x430;&#x437;&#x434;&#x435;&#x43B;&#x435; Add Generator Function
     *
     * https://developers.google.com/blockly/guides/configure/web/custom-blocks
     *
     * @param {Object} generatorsJS &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x444;&#x43E;&#x440;&#x43C;&#x430;&#x442;&#x430; Blockly (JavaScript), &#x437;&#x430;&#x434;&#x430;&#x44E;&#x449;&#x438;&#x439; &#x43E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x435;&#x43D;&#x438;&#x44F; &#x433;&#x435;&#x43D;&#x435;&#x440;&#x430;&#x442;&#x43E;&#x440;&#x43E;&#x432;
     */
    registerGenerators(generatorsJS) {
        this._generators = generatorsJS;

        this._loadGenerators();
    }

    /**
     * &#x412;&#x441;&#x442;&#x440;&#x43E;&#x438;&#x442;&#x44C; Blockly &#x432; DOM-&#x434;&#x435;&#x440;&#x435;&#x432;&#x43E;
     *
     * @param {Object}  dom_node        DOM-&#x443;&#x437;&#x435;&#x43B;, &#x432; &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x44B;&#x439; &#x43D;&#x443;&#x436;&#x43D;&#x43E; &#x432;&#x441;&#x442;&#x430;&#x432;&#x438;&#x442;&#x44C; Blockly
     * @param {boolean} use_scrollbars  &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x43B;&#x438; &#x441;&#x43A;&#x440;&#x43E;&#x43B;&#x43B;-&#x431;&#x430;&#x440;&#x44B;
     * @param {number}  zoom_initial    &#x438;&#x441;&#x445;&#x43E;&#x434;&#x43D;&#x44B;&#x439; &#x437;&#x443;&#x43C;-&#x444;&#x430;&#x43A;&#x442;&#x43E;&#x440;
     * @param {boolean} read_only       &#x440;&#x435;&#x436;&#x438;&#x43C; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; &#x447;&#x442;&#x435;&#x43D;&#x438;&#x44F;
     */
    inject(dom_node, use_scrollbars=false, read_only=false, zoom_initial=0.7) {
        /// &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x438;&#x442;&#x44C; &#x443;&#x437;&#x435;&#x43B; &#x432;&#x441;&#x442;&#x430;&#x432;&#x43A;&#x438; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x430;
        this.area        = dom_node;
        /// &#x421;&#x433;&#x435;&#x43D;&#x435;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x44B; &#x434;&#x43B;&#x44F; Blockly &#x438; &#x434;&#x43B;&#x44F; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
        this.container   = document.createElement(&apos;div&apos;);
        this.toolbox     = document.createElement(&apos;xml&apos;);
        this.dimmer     = document.createElement(&apos;div&apos;);
        /// &#x417;&#x430;&#x434;&#x430;&#x442;&#x44C; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x430;&#x43C; &#x441;&#x43E;&#x43E;&#x442;&#x432;&#x435;&#x442;&#x441;&#x442;&#x432;&#x443;&#x44E;&#x449;&#x438;&#x435; &#x438;&#x434;&#x435;&#x43D;&#x442;&#x438;&#x444;&#x438;&#x43A;&#x430;&#x442;&#x43E;&#x440;&#x44B;
        this.container.setAttribute(&quot;id&quot;, DIV_IDS.BLOCKLY);
        this.toolbox.setAttribute(&quot;id&quot;, DIV_IDS.TOOLBOX);

        if (!read_only) {
            this.dimmer.setAttribute(&quot;id&quot;, DIV_IDS.DIMMER);
            this.dimmer.setAttribute(&quot;style&quot;, this._getDimmerStyle());
            this.unlock();
        }

        this.toolbox.style.display = &apos;none&apos;;

        /// &#x420;&#x430;&#x437;&#x43C;&#x435;&#x441;&#x442;&#x438;&#x442;&#x44C; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x44B; &#x432; DOM-&#x434;&#x435;&#x440;&#x435;&#x432;&#x435;
        dom_node.appendChild(this.dimmer);
        dom_node.appendChild(this.container);
        dom_node.appendChild(this.toolbox);

        /// &#x412;&#x441;&#x442;&#x440;&#x43E;&#x438;&#x442;&#x44C; Blockly &#x432; &#x437;&#x430;&#x434;&#x430;&#x43D;&#x43D;&#x443;&#x44E; &#x441;&#x438;&#x441;&#x442;&#x435;&#x43C;&#x443; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x43E;&#x432;
        this.workspace = Blockly.inject(
            this.container,
            {
                toolbox: this.toolbox,
                readOnly: read_only,
                zoom: {
                    startScale: zoom_initial
                },
                scrollbars: use_scrollbars
            }
        );

        /// &#x417;&#x430;&#x43F;&#x43E;&#x43B;&#x43D;&#x438;&#x442;&#x44C; &#x431;&#x443;&#x444;&#x435;&#x440; &#x442;&#x435;&#x43A;&#x443;&#x449;&#x435;&#x433;&#x43E; &#x43A;&#x43E;&#x434;&#x430;, &#x435;&#x441;&#x43B;&#x438; &#x440;&#x430;&#x43D;&#x435;&#x435; &#x43D;&#x435; &#x431;&#x44B;&#x43B; &#x437;&#x430;&#x43F;&#x43E;&#x43B;&#x43D;&#x435;&#x43D;
        if (typeof this._state.code_buffer !== &quot;undefined&quot;) {
            Blockly.Xml.domToWorkspace(this._state.code_buffer, this.workspace);
        }

        /// &#x435;&#x441;&#x43B;&#x438; &#x43D;&#x435; &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x451;&#x43D; &#x440;&#x435;&#x436;&#x438;&#x43C; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; &#x447;&#x442;&#x435;&#x43D;&#x438;&#x44F; &#x438; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x439; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x43D;&#x435; &#x431;&#x44B;&#x43B; &#x437;&#x430;&#x440;&#x435;&#x433;&#x438;&#x441;&#x442;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D; &#x440;&#x430;&#x43D;&#x435;&#x435;
        if (!read_only &amp;&amp; !this._state.changeListenerRegistered) {
            this.workspace.addChangeListener(event =&gt; {
                if (!this.silent) {
                    this._filterEvent(event)
                }
            });
        }
        // window.addEventListener(&apos;resize&apos;, this._onResize, false);

        /// &#x410;&#x434;&#x430;&#x43F;&#x442;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x440;&#x430;&#x437;&#x43C;&#x435;&#x440; Blockly &#x43F;&#x43E;&#x434; &#x43D;&#x430;&#x447;&#x430;&#x43B;&#x44C;&#x43D;&#x44B;&#x439; &#x440;&#x430;&#x437;&#x43C;&#x435;&#x440; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x430;
        this._onResize();
        Blockly.svgResize(this.workspace);

        this._variable_blocks = [];
    }

    /**
     * &#x423;&#x434;&#x430;&#x43B;&#x438;&#x442;&#x44C; Blockly &#x438;&#x437; DOM-&#x434;&#x435;&#x440;&#x435;&#x432;&#x430;
     *
     * &#x421;&#x430;&#x43C; &#x44D;&#x43A;&#x437;&#x435;&#x43C;&#x43F;&#x43B;&#x44F;&#x440; Blockly, &#x435;&#x433;&#x43E; &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x438;&#x43C;&#x43E;&#x435; &#x438; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x44B; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x441;&#x43E;&#x445;&#x440;&#x430;&#x43D;&#x44F;&#x44E;&#x442;&#x441;&#x44F;
     */
    eject() {
        this._state.code_buffer = Blockly.Xml.workspaceToDom(this.workspace);

        /// &#x41E;&#x442;&#x43A;&#x43B;&#x44E;&#x447;&#x438;&#x442;&#x44C; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x435; Blockly
        this.workspace.dispose();
        /// &#x423;&#x434;&#x430;&#x43B;&#x438;&#x442;&#x44C; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x44B;
        this.dimmer.remove();
        this.container.remove();
        this.toolbox.remove();

        // window.removeEventListener(&apos;resize&apos;, this._onResize, false);
    }

    /**
     * &#x417;&#x430;&#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x43E;&#x440;
     *
     * &#x421;&#x43E;&#x43F;&#x440;&#x43E;&#x432;&#x43E;&#x436;&#x434;&#x430;&#x435;&#x442;&#x441;&#x44F; &#x437;&#x430;&#x442;&#x435;&#x43C;&#x43D;&#x435;&#x43D;&#x438;&#x435;&#x43C; &#x43A;&#x43E;&#x43D;&#x442;&#x435;&#x439;&#x43D;&#x435;&#x440;&#x430;
     *
     * @returns {boolean} &#x432;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x430; &#x43B;&#x438; &#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430;/&#x440;&#x430;&#x437;&#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430;
     */
    lock() {
        if (!this.dimmer) {return false}

        this.dimmer.className = this.dimmer.className.replace(new RegExp(`(?:^|\\s)${DIV_CLASSES.DIMMER_HIDDEN}(?!\\S)`) ,&apos;&apos;);

        return true;
    }

    /**
     * &#x420;&#x430;&#x437;&#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x43E;&#x440;
     *
     * @returns {boolean} &#x432;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x430; &#x43B;&#x438; &#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430;/&#x440;&#x430;&#x437;&#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430;
     */
    unlock() {
        if (!this.dimmer) {return false}

        let classes = this.dimmer.className.split(&quot; &quot;);
        if (classes.indexOf(DIV_CLASSES.DIMMER_HIDDEN) === -1) {
            this.dimmer.className += &quot; &quot; + DIV_CLASSES.DIMMER_HIDDEN;
        }
    }

    /**
     * &#x41E;&#x447;&#x438;&#x441;&#x442;&#x438;&#x442;&#x44C; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x43E;&#x440; &#x43E;&#x442; &#x43A;&#x43E;&#x434;&#x430;
     *
     * @returns {boolean} &#x432;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x430; &#x43B;&#x438; &#x43E;&#x447;&#x438;&#x441;&#x442;&#x43A;&#x430; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x43E;&#x440;&#x430;
     */
    clear() {
        if (!this.workspace) {return false}

        this.workspace.clear();
    }

    /**
     * &#x41E;&#x431;&#x43D;&#x43E;&#x432;&#x438;&#x442;&#x44C; &#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B; &#x434;&#x43E;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x43C;&#x43E;&#x433;&#x43E; &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x430; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * @param   {?number}    block_limit &#x43C;&#x430;&#x43A;&#x441;&#x438;&#x43C;&#x430;&#x43B;&#x44C;&#x43D;&#x43E; &#x434;&#x43E;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x43C;&#x43E;&#x435; &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     * @returns {boolean}    &#x432;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x43E; &#x43B;&#x438; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x430;
     */
    updateBlockLimit(block_limit) {
        if (!this.workspace) {return false}

        block_limit = block_limit &gt; 0 ? block_limit : 9999;

        this.workspace.options.maxBlocks = block_limit;
        this.workspace.flyout_.filterForCapacity_();

        return true;
    }

    /**
     * &#x41E;&#x431;&#x43D;&#x43E;&#x432;&#x438;&#x442;&#x44C; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * &#x41E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x44F;&#x435;&#x442;&#x441;&#x44F; &#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x434;&#x43E;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x43C;&#x44B;&#x445; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432; &#x432; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x43E;&#x440;&#x435;
     *
     * @param {Array&lt;Object&gt;} block_types &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x43E;&#x432; &#x442;&#x438;&#x43F;&#x430; {&#x442;&#x438;&#x43F;_&#x431;&#x43B;&#x43E;&#x43A;&#x430;: &#x43C;&#x430;&#x43A;&#x441;. &#x43A;&#x43E;&#x43B;-&#x432;&#x43E;}
     */
    updateBlockTypes(block_types) {
        let toolbox_content = &quot;&quot;;

        let block_type_array = Array.isArray(block_types) ? block_types : Object.keys(block_types);

        for (let block_type of block_type_array) {
            toolbox_content += &quot;&lt;block type=&apos;&quot; + block_type + &quot;&apos;&gt;&lt;/block&gt;&quot;;
        }

        this.toolbox.innerHTML = toolbox_content;

        this.workspace.updateToolbox(this.toolbox);
    }

    /**
     * &#x41F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x442;&#x438;&#x442;&#x44C; &#x431;&#x43B;&#x43E;&#x43A;
     *
     * &#x411;&#x43B;&#x43E;&#x43A; &#x441; &#x443;&#x43A;&#x430;&#x437;&#x430;&#x43D;&#x43D;&#x44B;&#x43C; ID &#x43F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x447;&#x438;&#x432;&#x430;&#x435;&#x442;&#x441;&#x44F; (&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x438;&#x442;&#x441;&#x44F; &#x44F;&#x440;&#x447;&#x435;).
     * &#x415;&#x441;&#x43B;&#x438; &#x43D;&#x430; &#x43C;&#x43E;&#x43C;&#x435;&#x43D;&#x442; &#x432;&#x44B;&#x437;&#x43E;&#x432;&#x430; &#x444;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x438; &#x432; &#x43A;&#x43E;&#x434;&#x435; &#x443;&#x436;&#x435; &#x441;&#x443;&#x449;&#x435;&#x441;&#x442;&#x432;&#x443;&#x44E;&#x442; &#x43F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x447;&#x435;&#x43D;&#x43D;&#x44B;&#x435; &#x431;&#x43B;&#x43E;&#x43A;&#x438;,
     * &#x438;&#x445; &#x43F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x442;&#x43A;&#x430; &#x438;&#x441;&#x447;&#x435;&#x437;&#x430;&#x435;&#x442;
     *
     * @param {string} block_id &#x438;&#x434;&#x435;&#x43D;&#x442;&#x438;&#x444;&#x438;&#x430;&#x43A;&#x442;&#x43E;&#x440; &#x431;&#x43B;&#x43E;&#x43A;&#x430; &#x432; &#x43D;&#x430;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x43E;&#x43C; &#x43A;&#x43E;&#x434;&#x435;
     */
    highlightBlock(block_id) {
        this.workspace.highlightBlock(block_id);
    }

    /**
     * &#x41F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x442;&#x438;&#x442;&#x44C; &#x431;&#x43B;&#x43E;&#x43A; &#x43A;&#x430;&#x43A; &#x43E;&#x448;&#x438;&#x431;&#x43E;&#x447;&#x43D;&#x44B;&#x439;
     *
     * &#x411;&#x43B;&#x43E;&#x43A; &#x441; &#x443;&#x43A;&#x430;&#x437;&#x430;&#x43D;&#x43D;&#x44B;&#x43C; ID &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x44F;&#x435;&#x442; &#x446;&#x432;&#x435;&#x442; &#x43D;&#x430; &#x446;&#x432;&#x435;&#x442; &#x43E;&#x448;&#x438;&#x431;&#x43E;&#x447;&#x43D;&#x43E;&#x433;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x430; ({@link ERROR_COLOUR})
     *
     * @param {string} block_id &#x438;&#x434;&#x435;&#x43D;&#x442;&#x438;&#x444;&#x438;&#x430;&#x43A;&#x442;&#x43E;&#x440; &#x431;&#x43B;&#x43E;&#x43A;&#x430; &#x432; &#x43D;&#x430;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x43E;&#x43C; &#x43A;&#x43E;&#x434;&#x435;
     */
    highlightErrorBlock(block_id) {
        let block = this.workspace.getBlockById(block_id);
        let colour = block.getColour(ERROR_COLOUR);

        block.setColour(ERROR_COLOUR);

        this._error_blocks[block_id] = {colour: colour, block: block};
    }

    /**
     * &#x41E;&#x447;&#x438;&#x441;&#x442;&#x438;&#x442;&#x44C; &#x43F;&#x43E;&#x434;&#x441;&#x432;&#x435;&#x442;&#x43A;&#x443; &#x443; &#x43E;&#x448;&#x438;&#x431;&#x43E;&#x447;&#x43D;&#x44B;&#x445; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     */
    clearErrorBlocks() {
        for (let block_id of Object.keys(this._error_blocks)) {
            let block = this._error_blocks[block_id].block;
            let colour = this._error_blocks[block_id].colour;

            block.setColour(colour);
            
            delete this._error_blocks[block_id];
        }
    }

    /**
     * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x442;&#x438;&#x442;&#x44C; &#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;, &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x443;&#x435;&#x43C;&#x44B;&#x445; &#x432; &#x43A;&#x43E;&#x434;&#x435;
     *
     * &#x424;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x44F; &#x444;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x442; &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x441;&#x442;&#x440;&#x43E;&#x43A;, &#x438;&#x434;&#x435;&#x43D;&#x442;&#x438;&#x444;&#x438;&#x446;&#x438;&#x440;&#x443;&#x44E;&#x449;&#x438;&#x445; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;, &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x44B;&#x435; &#x438;&#x441;&#x43E;&#x43B;&#x44C;&#x437;&#x443;&#x44E;&#x442;&#x441;&#x44F; &#x432; &#x43A;&#x43E;&#x434;&#x435;
     * &#x43D;&#x430; &#x43C;&#x43E;&#x43C;&#x435;&#x43D;&#x442; &#x432;&#x44B;&#x437;&#x43E;&#x432;&#x430; &#x444;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x438;
     *
     * @returns {Array&lt;string&gt;|boolean} &#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432; / false, &#x435;&#x441;&#x43B;&#x438; &#x43E;&#x43F;&#x435;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x43D;&#x435;&#x432;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x430;
     */
    getBlockTypes() {
        if (!this.workspace) {return false}

        let block_types = [];

        for (let block of this.workspace.getAllBlocks()) {
            if (!block.isShadow()) {
                block_types.push(block.type);
            }
        }

        return block_types;
    }

    /**
     * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x442;&#x438;&#x442;&#x44C; &#x434;&#x43E;&#x441;&#x442;&#x430;&#x442;&#x43E;&#x447;&#x43D;&#x43E;&#x435; (&#x43D;&#x43E; &#x43D;&#x435; &#x432;&#x441;&#x435;&#x433;&#x434;&#x430; &#x43D;&#x435;&#x43E;&#x431;&#x445;&#x43E;&#x434;&#x438;&#x43C;&#x43E;&#x435;) &#x447;&#x438;&#x441;&#x43B;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     * &#x434;&#x43B;&#x44F; &#x441;&#x431;&#x43E;&#x440;&#x43A;&#x438; &#x442;&#x435;&#x43A;&#x443;&#x449;&#x435;&#x439; &#x43F;&#x43E;&#x441;&#x43B;&#x435;&#x434;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x44C;&#x43D;&#x43E;&#x441;&#x442;&#x438; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * @returns {number} &#x447;&#x438;&#x441;&#x43B;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     */
    getBlockLimit() {
        if (!this.workspace) {return false}

        let block_count = 0;

        let blocks = this.workspace.getAllBlocks();

        let block_taken_ids = new Set();

        for (let block of blocks) {
            if (!block_taken_ids.has(block.id)) {
                block_count += 1;
            }

            block_taken_ids.add(block.id);

            for (let subblock of block.childBlocks_) {
                /// &#x411;&#x43B;&#x43E;&#x43A; &#x43D;&#x435; &#x434;&#x43E;&#x43B;&#x436;&#x435;&#x43D; &#x431;&#x44B;&#x442;&#x44C; &#x432;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x43D;&#x43E;&#x439; &#x446;&#x435;&#x43F;&#x43E;&#x447;&#x43A;&#x43E;&#x439;
                if (subblock.nextConnection || subblock.previousConnection) {
                    continue;
                }

                if (block_taken_ids.has(subblock.id)) {
                    if (!subblock.isShadow_) {
                        block_count += 1;
                    }
                } else  {
                    if (!subblock.isShadow_) {
                        block_count += 2;
                    } else {
                        block_count += 1;
                    }
                }

                block_taken_ids.add(subblock.id);
            }
        }

        return block_count;
    }

    /**
     * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x442;&#x438;&#x442;&#x44C; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x43F;&#x43E;&#x43B;&#x435;&#x439;, &#x43E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x44E;&#x449;&#x438;&#x445; &#x43C;&#x430;&#x43A;&#x441;&#x438;&#x43C;&#x430;&#x43B;&#x44C;&#x43D;&#x43E; &#x434;&#x43E;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x43C;&#x43E;&#x435; &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;,
     * &#x43F;&#x43E; &#x432;&#x441;&#x435;&#x43C; &#x442;&#x438;&#x43F;&#x430;&#x43C; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * @returns {Array&lt;Object&gt;} &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x43E;&#x432; &#x442;&#x438;&#x43F;&#x430; {&#x442;&#x438;&#x43F;_&#x431;&#x43B;&#x43E;&#x43A;&#x430;: &#x43C;&#x430;&#x43A;&#x441;. &#x43A;&#x43E;&#x43B;-&#x432;&#x43E;}
     */
    getBlockLimitInputsByType() {
        if (!this.workspace) {return false}

        let block_counts = {};

        for (let block of this.workspace.getAllBlocks()) {
            for (let input of block.inputList) {
                for (let field of input.fieldRow) {
                    if (field.name === &quot;MAX_COUNT&quot;) {
                        block_counts[block.type] = parseInt(field.text_);
                    }
                }
            }
        }

        return block_counts;
    }

    /**
     * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x438;&#x442;&#x44C; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x43F;&#x43E;&#x43B;&#x435;&#x439;, &#x43E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x44E;&#x449;&#x438;&#x445; &#x43C;&#x430;&#x43A;&#x441;&#x438;&#x43C;&#x430;&#x43B;&#x44C;&#x43D;&#x43E; &#x434;&#x43E;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x43C;&#x43E;&#x435; &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;,
     * &#x43F;&#x43E; &#x432;&#x441;&#x435;&#x43C; &#x442;&#x438;&#x43F;&#x430;&#x43C; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * @param block_counts {Array&lt;Object&gt;} &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x43E;&#x432; &#x442;&#x438;&#x43F;&#x430; {&#x442;&#x438;&#x43F;_&#x431;&#x43B;&#x43E;&#x43A;&#x430;: &#x43C;&#x430;&#x43A;&#x441;. &#x43A;&#x43E;&#x43B;-&#x432;&#x43E;}
     */
    setBlockLimitInputsByType(block_counts) {
        if (!this.workspace) {return false}

        if (!block_counts) {return false}

        for (let block of this.workspace.getAllBlocks()) {
            for (let input of block.inputList) {
                for (let field of input.fieldRow) {
                    if (field.name === &quot;MAX_COUNT&quot;) {
                        console.log(field);
                        let value = block_counts[block.type] || 0;

                        field.setValue(value);
                    }
                }
            }
        }

    }

    /**
     * &#x41F;&#x43E;&#x43B;&#x443;&#x447;&#x438;&#x442;&#x44C; &#x442;&#x435;&#x43A;&#x443;&#x449;&#x438;&#x439; &#x43A;&#x43E;&#x434; &#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x44B; Blockly &#x432; &#x43D;&#x43E;&#x442;&#x430;&#x446;&#x438;&#x438; XML
     *
     * @see https://developers.google.com/blockly/guides/get-started/web
     *
     * @returns {string} &#x441;&#x442;&#x440;&#x43E;&#x43A;&#x430;, &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x430;&#x449;&#x430;&#x44F; XML-&#x43A;&#x43E;&#x434; &#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x44B;
     */
    getXMLCode() {
        let xml = Blockly.Xml.workspaceToDom(this.workspace);

        return Blockly.Xml.domToText(xml);
    }

    /**
     * &#x41F;&#x43E;&#x43B;&#x443;&#x447;&#x438;&#x442;&#x44C; &#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432; &#x432; &#x432;&#x438;&#x434;&#x435; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x430;
     *
     * &#x41E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; - &#x43F;&#x43E;&#x441;&#x43B;&#x435;&#x434;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x44C;&#x43D;&#x43E;&#x441;&#x442;&#x44C; &#x43A;&#x43E;&#x43C;&#x430;&#x43D;&#x434;, &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x430;&#x44F; &#x441;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x442;
     * &#x43F;&#x440;&#x438; &#x43D;&#x430;&#x436;&#x430;&#x442;&#x438;&#x438; &#x43D;&#x430; &#x43A;&#x43B;&#x430;&#x432;&#x438;&#x448;&#x443; &#x441; &#x441;&#x43E;&#x43E;&#x442;&#x432;&#x435;&#x442;&#x441;&#x442;&#x432;&#x443;&#x44E;&#x449;&#x438;&#x43C; &#x43A;&#x43E;&#x434;&#x43E;&#x43C;.
     *
     * &#x413;&#x43B;&#x430;&#x432;&#x43D;&#x44B;&#x439; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; - &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;, &#x441;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x44E;&#x449;&#x438;&#x439; &#x43F;&#x440;&#x438; &#x43D;&#x430;&#x436;&#x430;&#x442;&#x438;&#x438; &#x43A;&#x43D;&#x43E;&#x43F;&#x43A;&#x438; &quot;&#x417;&#x430;&#x43F;&#x443;&#x441;&#x442;&#x438;&#x442;&#x44C;&quot;.
     *
     * &#x424;&#x43E;&#x440;&#x43C;&#x430;&#x442; &#x441;&#x43F;&#x438;&#x441;&#x43A;&#x430; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432;:
     *
     * `{{main: string, sub: Object}}`,
     *
     * &#x433;&#x434;&#x435; &#x43A;&#x43B;&#x44E;&#x447; `main` &#x443;&#x43A;&#x430;&#x437;&#x44B;&#x432;&#x430;&#x435;&#x442; &#x43D;&#x430; &#x433;&#x43B;&#x430;&#x432;&#x43D;&#x44B;&#x439; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;.
     *
     * &#x41A;&#x43B;&#x44E;&#x447; `sub` &#x443;&#x43A;&#x430;&#x437;&#x44B;&#x432;&#x430;&#x435;&#x442; &#x43D;&#x430; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;, &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x430;&#x449;&#x438;&#x439; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x438; &#x43D;&#x430;&#x436;&#x430;&#x442;&#x438;&#x439; &#x43A;&#x43B;&#x430;&#x432;&#x438;&#x448;:
     * &#x43A;&#x430;&#x436;&#x434;&#x44B;&#x439; &#x435;&#x433;&#x43E; &#x43A;&#x43B;&#x44E;&#x447; - ID &#x431;&#x43B;&#x43E;&#x43A;&#x430;-&#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x430;, &#x443;&#x43A;&#x430;&#x437;&#x44B;&#x432;&#x430;&#x44E;&#x449;&#x438;&#x439; &#x43D;&#x430; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x442;&#x438;&#x43F;&#x430;
     *
     * {btn: number, code: string},
     *
     * &#x433;&#x434;&#x435; btn - &#x43A;&#x43E;&#x434; &#x43A;&#x43B;&#x430;&#x432;&#x438;&#x448;&#x438;, &#x43D;&#x430;&#x436;&#x430;&#x442;&#x438;&#x435; &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x43E;&#x439; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x442;&#x441;&#x44F;, code - &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &#x435;&#x451; &#x43D;&#x430;&#x436;&#x430;&#x442;&#x438;&#x44F;.
     *
     * @returns {{main: string, sub: Object}}
     */
    getJSONHandlers() {
        let code = Blockly.JSON.workspaceToCode(this.workspace);
        let statements = Blockly.JSON.audible_args;

        this._lastCodeMain = code;

        return {main: code, sub: statements};
    }

    /**
     * &#x41F;&#x43E;&#x43B;&#x443;&#x447;&#x438;&#x442;&#x44C; &#x441;&#x442;&#x440;&#x43E;&#x43A;&#x443; &#x441; XML-&#x43A;&#x43E;&#x434;&#x43E;&#x43C; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x44F; &#x440;&#x430;&#x431;&#x43E;&#x447;&#x435;&#x439; &#x43E;&#x431;&#x43B;&#x430;&#x441;&#x442;&#x438; Blockly
     *
     * @returns {string} &#x441;&#x442;&#x440;&#x43E;&#x43A;&#x430;, &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x430;&#x449;&#x430;&#x44F; XML-&#x43F;&#x440;&#x435;&#x434;&#x441;&#x442;&#x430;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x43D;&#x430;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x43E;&#x433;&#x43E; &#x43A;&#x43E;&#x434;&#x430;
     */
    getXMLText() {
        let dom = Blockly.Xml.workspaceToDom(this.workspace);
        return Blockly.Xml.domToText(dom);
    }

    /**
     * &#x417;&#x430;&#x434;&#x430;&#x442;&#x44C; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x435; &#x440;&#x430;&#x431;&#x43E;&#x447;&#x435;&#x439; &#x43E;&#x431;&#x43B;&#x430;&#x441;&#x442;&#x438; Blockly &#x447;&#x435;&#x440;&#x435;&#x437; &#x441;&#x442;&#x440;&#x43E;&#x43A;&#x443; &#x441; XML-&#x43A;&#x43E;&#x434;&#x43E;&#x43C;
     *
     * @param text &#x441;&#x442;&#x440;&#x43E;&#x43A;&#x430;, &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x430;&#x449;&#x430;&#x44F; XML-&#x43F;&#x440;&#x435;&#x434;&#x441;&#x442;&#x430;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x43A;&#x43E;&#x434;&#x430; Blockly
     */
    setXMLText(text) {
        let dom = Blockly.Xml.textToDom(text);
        Blockly.Xml.domToWorkspace(dom, this.workspace);
    }

    /**
     * &#x417;&#x430;&#x434;&#x430;&#x442;&#x44C; &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;-&#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432;
     *
     * &#x412;&#x43F;&#x43E;&#x441;&#x43B;&#x435;&#x434;&#x441;&#x442;&#x432;&#x438;&#x438; &#x432; &#x44D;&#x442;&#x438;&#x445; &#x431;&#x43B;&#x43E;&#x43A;&#x430;&#x445; &#x431;&#x443;&#x434;&#x443;&#x442; &#x43E;&#x431;&#x43D;&#x430;&#x440;&#x436;&#x443;&#x438;&#x432;&#x430;&#x442;&#x44C;&#x441;&#x44F; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x438;&#x435; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F;
     *
     * @param {Array} audibles &#x43C;&#x430;&#x441;&#x441;&#x438;&#x432; &#x43D;&#x430;&#x437;&#x432;&#x430;&#x43D;&#x438;&#x439; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;-&#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432;
     */
    setAudibles(audibles) {
        this._audibles = audibles;
    }

    /**
     * &#x417;&#x430;&#x434;&#x430;&#x442;&#x44C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x44F; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x43E;&#x441;&#x43D;&#x43E;&#x432;&#x43D;&#x43E;&#x433;&#x43E; &#x43A;&#x43E;&#x434;&#x430;
     *
     * @deprecated
     *
     * @param {function} callback &#x444;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x44F;, &#x432;&#x44B;&#x437;&#x44B;&#x432;&#x430;&#x44E;&#x449;&#x430;&#x44F;&#x441;&#x44F; &#x43F;&#x440;&#x438; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x438; &#x43E;&#x441;&#x43D;&#x43E;&#x432;&#x43D;&#x43E;&#x433;&#x43E; &#x43A;&#x43E;&#x434;&#x430;
     */
    onChange(callback) {
        this._callbacks.onChange = callback;
    }

    /**
     * &#x41D;&#x430;&#x437;&#x43D;&#x430;&#x447;&#x438;&#x442;&#x44C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x44F; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x438;&#x445; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x439; &#x432; &#x43A;&#x43E;&#x434;&#x435;
     *
     * &#x41A; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x438;&#x43C; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F;&#x43C; &#x43E;&#x442;&#x43D;&#x43E;&#x441;&#x44F;&#x442;&#x441;&#x44F;:
     *  - &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;, &#x437;&#x430;&#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445; &#x432; _audibles
     *  - &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;, &#x432;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x43D;&#x44B;&#x445; &#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x438;, &#x437;&#x430;&#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x432; _audibles
     *
     *  &#x41E; &#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x435; &#x443;&#x440;&#x43E;&#x432;&#x43D;&#x44F; &#x432;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x43D;&#x43E;&#x441;&#x442;&#x438; &#x441;&#x43C;. {@link _filterEvent}
     *
     * @param callback  &#x444;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x44F; &#x43E;&#x431;&#x440;&#x430;&#x442;&#x43D;&#x43E;&#x433;&#x43E; &#x432;&#x44B;&#x437;&#x43E;&#x432;&#x430;, &#x432; &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x443;&#x44E; &#x43F;&#x440;&#x438; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x438;&#x445; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F;&#x445; &#x431;&#x443;&#x434;&#x443;&#x442; &#x43F;&#x435;&#x440;&#x435;&#x434;&#x430;&#x432;&#x430;&#x442;&#x44C;&#x441;&#x44F;
     *                  &#x441;&#x43B;&#x435;&#x434;&#x443;&#x44E;&#x449;&#x438;&#x435; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x44B;:
 *                          - {string} &#x43A;&#x43E;&#x434; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x451;&#x43D;&#x43D;&#x43E;&#x433;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x430;-&#x440;&#x43E;&#x434;&#x438;&#x442;&#x435;&#x43B;&#x44F;
     *                      - {string} &#x432;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x43D;&#x44B;&#x439; &#x43A;&#x43E;&#x434; &#x431;&#x43B;&#x43E;&#x43A;&#x430;-&#x440;&#x43E;&#x434;&#x438;&#x442;&#x435;&#x43B;&#x44F; (&#x435;&#x441;&#x43B;&#x438; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x451;&#x43D;)
     */
    onChangeAudible(callback) {
        this._callbacks.onChangeAudible = callback;
    }

    /**
     * &#x417;&#x430;&#x433;&#x440;&#x443;&#x437;&#x438;&#x442;&#x44C; &#x442;&#x438;&#x43F;&#x44B; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432; &#x432; JSON
     *
     * @private
     */
    _loadBlocksJSON() {
        for (let block_name of Object.keys(this._block_types)) {
            Blockly.Blocks[block_name] = this._block_types[block_name];
        }
    }

    /**
     * &#x417;&#x430;&#x433;&#x440;&#x443;&#x437;&#x438;&#x442;&#x44C; &#x433;&#x435;&#x43D;&#x435;&#x440;&#x430;&#x442;&#x43E;&#x440;&#x44B; &#x434;&#x43B;&#x44F; &#x442;&#x438;&#x43F;&#x43E;&#x432; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;
     *
     * @private
     */
    _loadGenerators() {
        for (let generator_name of Object.keys(this._generators)) {
            Blockly.JSON[generator_name] = this._generators[generator_name];
        }
    }

    //
    // &#x41E;&#x422;&#x41E;&#x411;&#x420;&#x410;&#x416;&#x415;&#x41D;&#x418;&#x415; &#x41F;&#x415;&#x420;&#x415;&#x41C;&#x415;&#x41D;&#x41D;&#x42B;&#x425;
    //

    /**
     * &#x414;&#x43E;&#x431;&#x430;&#x432;&#x438;&#x442;&#x44C; &#x431;&#x43B;&#x43E;&#x43A;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x443;&#x44E;
     *
     * @param {string}              block_type &#x442;&#x438;&#x43F; &#x431;&#x43B;&#x43E;&#x43A;&#x430;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439;
     * @param {string}              field_type &#x442;&#x438;&#x43F; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; ({@link FIELD_TYPES})
     * @param {?string|number}      value &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; &#x43F;&#x43E; &#x443;&#x43C;&#x43E;&#x43B;&#x447;&#x430;&#x43D;&#x438;&#x44E;
     */
    addVariableBlock(block_type, field_type=FIELD_TYPES.STRING, value=0) {
        let block = this.workspace.newBlock(block_type);

        block.initSvg();
        block.render();

        let variable_name = &quot;&quot;;
        let pos_y = this._getAllVariablesHeight();

        try {
            variable_name = block.inputList[0].fieldRow[0].text_;
        } catch (e) {
            console.error(&quot;Variable block of type `&quot; + block_type + &quot;` has not a dummy input at 0 index&quot;);
        }

        this._addFieldToVariableBlock(block, field_type);

        block.setFieldValue(variable_name + &quot; = &quot;);
        block.setFieldValue(value, &quot;DUMMY&quot;);
        block.moveBy(0, pos_y);

        this._variable_blocks[block_type] = {name: variable_name, element: block, pos_y: pos_y};
    }

    /**
     * &#x41E;&#x447;&#x438;&#x441;&#x442;&#x438;&#x442;&#x44C; &#x431;&#x43B;&#x43E;&#x43A;&#x438;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x44B;&#x435;
     */
    clearVariableBlocks() {
        for (let block_type in this._variable_blocks) {
            this._variable_blocks[block_type].element.dispose();
        }

        this._variable_blocks = [];
    }

    /**
     * &#x417;&#x430;&#x434;&#x430;&#x442;&#x44C; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x431;&#x43B;&#x43E;&#x43A;&#x443;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439;
     *
     * @param {string}          type    &#x442;&#x438;&#x43F; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; ({@link FIELD_TYPES})
     * @param {?string|number}  value   &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; &#x43F;&#x43E; &#x443;&#x43C;&#x43E;&#x43B;&#x447;&#x430;&#x43D;&#x438;&#x44E;
     */
    setVariableBlockValue(type, value=0) {
        let block = this._variable_blocks[type];

        if (!block) {throw new RangeError(&quot;Variable of type `&quot; + type + &quot;`does not exist in the base&quot;)}

        block.element.setFieldValue(value, &quot;DUMMY&quot;);
    }

    /**
     * &#x414;&#x43E;&#x431;&#x430;&#x432;&#x438;&#x442;&#x44C; &#x43F;&#x43E;&#x43B;&#x435; &#x431;&#x43B;&#x43E;&#x43A;&#x443;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439;
     *
     * @param {Blockly.BlockSvg}   block      &#x431;&#x43B;&#x43E;&#x43A;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x430;&#x44F;
     * @param {string}             field_type &#x442;&#x438;&#x43F; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x43E;&#x439; ({@link FIELD_TYPES})
     *
     * @private
     */
    _addFieldToVariableBlock(block, field_type) {
        let field = undefined;

        switch (field_type) {
            case FIELD_TYPES.NUMBER: {
                field = new Blockly.FieldNumber(); /// no constraints
                break;
            }
            case FIELD_TYPES.STRING: {
                field = new Blockly.FieldTextInput(); /// no constraints
                break;
            }
            case FIELD_TYPES.COLOUR: {
                field = new Blockly.FieldColour();
                break;
            }
            default: {
                field = new Blockly.FieldLabel();
                break;
            }
        }

        block.setInputsInline(true);
        block.appendDummyInput()
            .appendField(field, &quot;DUMMY&quot;);
    }

    /**
     * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x438;&#x442;&#x44C; &#x432;&#x44B;&#x441;&#x43E;&#x442;&#x443;, &#x437;&#x430;&#x43D;&#x438;&#x43C;&#x430;&#x435;&#x43C;&#x443;&#x44E; &#x432;&#x441;&#x435;&#x43C;&#x438; &#x431;&#x43B;&#x43E;&#x43A;&#x430;&#x43C;&#x438;-&#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x43D;&#x43D;&#x44B;&#x43C;&#x438;
     *
     * @returns {number} &#x432;&#x44B;&#x441;&#x43E;&#x442;&#x430; &#x432; px
     *
     * @private
     */
    _getAllVariablesHeight() {
        let height_sum = 0;

        for (let block_type in this._variable_blocks) {
            height_sum += this._variable_blocks[block_type].element.height;
        }

        return height_sum;
    }

    /**
     * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x438;&#x442;&#x44C; &#x441;&#x442;&#x438;&#x43B;&#x44C; &#x43E;&#x432;&#x435;&#x440;&#x43B;&#x435;&#x44F;
     *
     * @private
     */
    _getDimmerStyle() {
        return &quot;position: absolute; width: 98%; height: 98%; z-index: 21;&quot;;
    }

    /**
     * &#x418;&#x437;&#x43C;&#x435;&#x43D;&#x438;&#x442;&#x44C; &#x440;&#x430;&#x437;&#x43C;&#x435;&#x440; &#x433;&#x440;&#x430;&#x444;&#x438;&#x43A;&#x438; Blockly
     *
     * @see https://developers.google.com/blockly/guides/configure/web/resizable
     *
     * @private
     */
    _onResize() {
        this.container.style.width   = (this.area.offsetWidth - 24) + &apos;px&apos;;
        this.container.style.height  = (this.area.offsetHeight - 24) + &apos;px&apos;;
        Blockly.svgResize(this.workspace);
    }

    /**
     * &#x412;&#x44B;&#x43F;&#x43E;&#x43B;&#x43D;&#x438;&#x442;&#x44C; &#x43F;&#x435;&#x440;&#x432;&#x438;&#x447;&#x43D;&#x43A;&#x44E; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x43A;&#x443; &#x441;&#x442;&#x430;&#x43D;&#x434;&#x430;&#x440;&#x442;&#x43D;&#x44B;&#x445; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x439; Blockly
     *
     * &#x41E;&#x431;&#x43D;&#x430;&#x440;&#x443;&#x436;&#x438;&#x432;&#x430;&#x44E;&#x442;&#x441;&#x44F; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x438;&#x435; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x434;&#x43B;&#x44F; &#x431;&#x43B;&#x43E;&#x43A;&#x43E;&#x432;-&#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432;, &#x437;&#x430;&#x434;&#x430;&#x432;&#x430;&#x435;&#x43C;&#x44B;&#x445;
     * &#x441; &#x43F;&#x43E;&#x43C;&#x43E;&#x449;&#x44C;&#x44E; &#x444;&#x443;&#x43D;&#x43A;&#x446;&#x438;&#x438; {@link setAudibles}
     *
     * @param event &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x435; Blockly
     *
     * @private
     */
    _filterEvent(event) {
        if (this.extra_fields) {
            if (event.type === Blockly.Events.CREATE) {
                let block = this.workspace.getBlockById(event.blockId);

                block.appendDummyInput()
                    .appendField(new Blockly.FieldLabel(&quot;[&#x41C;&#x410;&#x41A;&#x421;. &#x41A;&#x41E;&#x41B;-&#x412;&#x41E;]&quot;), &quot;LABEL&quot;)
                    .appendField(new Blockly.FieldNumber(), &quot;MAX_COUNT&quot;);

                this._callbacks.onChange();
            }
        }

        if (event.type === Blockly.Events.CHANGE || event.type === Blockly.Events.MOVE) {
            this._callbacks.onChange();
        }
        // if (event.type === Blockly.Events.CHANGE || event.type === Blockly.Events.MOVE) {
        //     let is_deep_change = false;
        //
        //     let block = undefined;
        //     let is_orphan = false;
        //
        //     if (event.oldParentId) {
        //         block = this.workspace.getBlockById(event.oldParentId);
        //         is_orphan = true;
        //     } else {
        //         block = this.workspace.getBlockById(event.blockId);
        //     }
        //
        //     if (block) {
        //         /// &#x41A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439; &#x431;&#x43B;&#x43E;&#x43A; (&#x43D;&#x435; &#x438;&#x43C;&#x435;&#x44E;&#x449;&#x438;&#x439; &#x440;&#x43E;&#x434;&#x438;&#x442;&#x435;&#x43B;&#x435;&#x439;)
        //         let root = block.getRootBlock();
        //
        //         /// &#x415;&#x441;&#x43B;&#x438; &#x44D;&#x442;&#x43E;&#x442; &#x431;&#x43B;&#x43E;&#x43A; &#x43D;&#x443;&#x436;&#x43D;&#x43E; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x43E; &#x43F;&#x440;&#x43E;&#x441;&#x43B;&#x443;&#x448;&#x438;&#x432;&#x430;&#x442;&#x44C; (&#x43D;&#x430;&#x43F;&#x440;., &#x44D;&#x442;&#x43E; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;)
        //         if (this._audibles.indexOf(root.type) &gt;= 0) {
        //             /// &#x415;&#x441;&#x43B;&#x438; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43D;&#x435; &#x44F;&#x432;&#x43B;&#x44F;&#x435;&#x442;&#x441;&#x44F; &#x440;&#x435;&#x437;&#x443;&#x43B;&#x44C;&#x442;&#x430;&#x442;&#x43E;&#x43C; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x449;&#x435;&#x43D;&#x438;&#x44F; &#x440;&#x43E;&#x434;&#x438;&#x442;&#x435;&#x43B;&#x44C;&#x441;&#x43A;&#x43E;&#x433;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x430;
        //             if (!(event.type === Blockly.Events.MOVE &amp;&amp; block === root &amp;&amp; !is_orphan)) {
        //                 /// &#x43E;&#x442;&#x43C;&#x435;&#x442;&#x438;&#x442;&#x44C;, &#x447;&#x442;&#x43E; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; - &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x43E;&#x435;
        //                 is_deep_change = true;
        //
        //                 /// &#x435;&#x441;&#x43B;&#x438; &#x43D;&#x435;&#x442; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x430; &#x441; &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x43C;&#x438; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x43E;&#x432;, &#x441;&#x43E;&#x437;&#x434;&#x430;&#x442;&#x44C; &#x43F;&#x443;&#x441;&#x442;&#x43E;&#x439;
        //                 if (typeof Blockly.JSON.audible_args === &quot;undefined&quot;) {
        //                     Blockly.JSON.audible_args = {};
        //                 }
        //
        //                 /// &#x437;&#x430;&#x444;&#x438;&#x43A;&#x441;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &quot;&#x434;&#x43E;&quot;
        //                 let audible_args_before = Blockly.JSON.audible_args[root.id];
        //                 /// &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x438;&#x442;&#x44C; &#x438;&#x43D;&#x444;&#x43E;&#x440;&#x43C;&#x430;&#x446;&#x438;&#x44E; &#x43E;&#x431; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x435;
        //                 Blockly.JSON.blockToCode(root);
        //                 /// &#x437;&#x430;&#x444;&#x438;&#x43A;&#x441;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A; &quot;&#x43F;&#x43E;&#x441;&#x43B;&#x435;&quot;
        //                 let audible_args_after = Blockly.JSON.audible_args[root.id];
        //
        //                 /// &#x43F;&#x43E; &#x443;&#x43C;&#x43E;&#x43B;&#x447;&#x430;&#x43D;&#x438;&#x44E;
        //                 let audible_args = {
        //                     btn: audible_args_after.btn
        //                 };
        //
        //                 /// &#x435;&#x441;&#x43B;&#x438; &#x43A;&#x43E;&#x434; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x430; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x438;&#x43B;&#x441;&#x44F;
        //                 if (!audible_args_before || (audible_args_before.code !== audible_args_after.code)) {
        //                     audible_args[&quot;code&quot;] = audible_args_after.code;
        //                 }
        //
        //                 this._callbacks.onChangeAudible(root.id, audible_args);
        //
        //             } // &lt;&#x435;&#x441;&#x43B;&#x438; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43D;&#x435; &#x44F;&#x432;&#x43B;&#x44F;&#x435;&#x442;&#x441;&#x44F; &#x440;&#x435;&#x437;&#x443;&#x43B;&#x44C;&#x442;&#x430;&#x442;&#x43E;&#x43C; &#x43F;&#x435;&#x440;&#x435;&#x43C;&#x435;&#x449;&#x435;&#x43D;&#x438;&#x44F; &#x440;&#x43E;&#x434;&#x438;&#x442;&#x435;&#x43B;&#x44C;&#x441;&#x43A;&#x43E;&#x433;&#x43E; &#x431;&#x43B;&#x43E;&#x43A;&#x430;&gt;
        //         } // &lt;&#x435;&#x441;&#x43B;&#x438; &#x431;&#x43B;&#x43E;&#x43A; &#x432; &#x441;&#x43F;&#x438;&#x441;&#x43A;&#x435; _audibles&gt;
        //     } // &lt;&#x435;&#x441;&#x43B;&#x438; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x435; &#x434;&#x43B;&#x44F; &#x431;&#x43B;&#x43E;&#x43A;&#x430;&gt;
        //
        //     /// &#x415;&#x441;&#x43B;&#x438; &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; - &#x43D;&#x435; &#x433;&#x43B;&#x443;&#x431;&#x43E;&#x43A;&#x43E;&#x435;, &#x443;&#x447;&#x435;&#x441;&#x442;&#x44C; &#x44D;&#x442;&#x43E;&#x442; &#x441;&#x43B;&#x443;&#x447;&#x430;&#x439;
        //     if (!is_deep_change) {
        //         let code_after = Blockly.JSON.workspaceToCode(this.workspace);
        //
        //         if (this._lastCodeMain !== code_after) {
        //             this._callbacks.onChange(code_after);
        //
        //             this._lastCodeMain = code_after;
        //         }
        //     }
        // }
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
